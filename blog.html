<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/blog-select.css" />
    <title>Blog</title>
    <style>
      /* Add your CSS styles here */
      .blog_box {
        background-color: #1c1c1c;
        border: 1px solid #e5e5e5;
        border-radius: 15px;
        display: flex;
        flex-direction: row;
        justify-content: left;
        width: 400px;
        height: 200px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .icon {
        width: 75px;
        height: 75px;
        border-radius: 10px;
        margin-right: 15px;
      }
      .details {
        display: flex;
        flex-direction: column;
        flex: 1;
      }
      .Date {
        color: #e5e5e5;
      }
      .tagboxes {
        display: flex;
        flex-direction: row;
        overflow: auto;
      }
      .tag {
        background-color: #2b2b32;
        display: flex;
        align-items: center;
        padding: 5px 11px;
        border-radius: 10px;
        margin-right: 5px;
      }
      .tagicon {
        width: 12px;
        height: 12px;
      }
      .tagtext {
        font-size: 12px;
        margin-left: 2.5px;
        color: #e5e5e5;
      }
      .description {
        overflow: hidden;
        text-overflow: ellipsis;
        height: 70px;
        color: #e5e5e5;
      }
      .blogTitle {
        color: #e5e5e5;
      }
      .center-horizontally {
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <ul>
        <div style="width: fit-content; margin: 0 auto">
          <li><a href="index.html">[ Home ]</a></li>
          <li><a href="Projects.html">[ Projects ]</a></li>
          <li><a href="blog.html">[ Blog ]</a></li>
        </div>
        <img
          id="random-image"
          src=""
          alt="Random Image"
          width="50"
          height="50"
          style="margin-top: 1%; float: right; margin-right: 1%"
        />
      </ul>
    </nav>

    <div id="posts-container" class="center-horizontally">
      <!-- Blog posts will be injected here -->
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const csvFilePath = "/data/posts.csv"; // Adjust path based on where your CSV is located
        const tagsFilePath = "/data/tags.json"; // Adjust path based on where your tags JSON is located

        const parseCSV = (data) => {
          const lines = data.split("\n").filter((line) => line.trim());
          const result = [];
          const headers = lines[0].split(",").map((header) => header.trim());

          for (let i = 1; i < lines.length; i++) {
            const obj = {};
            const currentline = lines[i].split(",").map((cell) => cell.trim());

            headers.forEach((header, index) => {
              obj[header] = currentline[index];
            });

            result.push(obj);
          }
          return result;
        };

        const fetchCSV = async (url) => {
          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Network response was not ok");
            const text = await response.text();
            return parseCSV(text);
          } catch (error) {
            console.error("Error fetching CSV file:", error);
            return [];
          }
        };

        const fetchJsonFile = async (url) => {
          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
          } catch (error) {
            console.error("Error fetching JSON file:", error);
            return {};
          }
        };

        const fetchTagIcons = async () => {
          try {
            return await fetchJsonFile(tagsFilePath);
          } catch (error) {
            console.error("Error fetching tag icons:", error);
            return [];
          }
        };

        const renderPosts = async (posts, tagIcons) => {
          const postsContainer = document.getElementById("posts-container");
          postsContainer.innerHTML = "";

          for (const post of posts) {
            try {
              const postData = await fetchJsonFile(post.jsonFile);
              const tags = postData.tags.map((tag) => tag.trim());
              const tagElements = tags
                .map((tag) => {
                  const tagIcon = tagIcons.find(
                    (icon) => icon.tag_name === tag
                  );
                  return tagIcon
                    ? `
                      <div class="tag">
                        <img src="${tagIcon.icon}" class="tagicon" alt="${tag} Icon" />
                        <span class="tagtext">${tag}</span>
                      </div>
                    `
                    : "";
                })
                .join("");

              const postElement = document.createElement("a");
              postElement.href = "#"; // Update with actual URL if needed
              postElement.innerHTML = `
              <div class="blog_box">
                <div class="Image">
                  <img src="${postData.bannerImage}" alt="${
                postData.title
              }" class="icon" />
                </div>
                <div class="details">
                  <h2 class="blogTitle">${postData.title}</h2>
                  <p class="Date">Date: ${new Date(
                    postData.date
                  ).toLocaleDateString()}</p>
                  <div class="tagboxes">${tagElements}</div>
                  <p class="description">${postData.content}</p>
                </div>
              </div>
            `;
              postsContainer.appendChild(postElement);
            } catch (error) {
              console.error("Error rendering post:", error);
            }
          }
        };

        try {
          const posts = await fetchCSV(csvFilePath);
          const tagIcons = await fetchTagIcons();
          // Slice the posts array to get only the top 10 posts
          const topPosts = posts.slice(0, 10);
          renderPosts(topPosts, tagIcons);
        } catch (error) {
          console.error("Error in fetching or rendering:", error);
        }
      });
    </script>
  </body>
</html>
